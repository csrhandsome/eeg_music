<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Real-time Data with D3.js</title>
    <!-- 引入 D3.js -->
    <script src="d3.min.js"></script>
    <!-- 引入 p5.js -->
    <script src="p5.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #000000;}
        #data-container {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            min-height: 100px;
            background-color: #f9f9f9;
        }
        .data-item {
            padding: 5px;
            border-bottom: 1px dotted #eee;
        }
        .data-item:last-child {
            border-bottom: none;
        }
        /* 你可以在这里添加 D3.js 可视化的样式 */
        .chart {
            border: 1px solid steelblue;
        }
    </style>
</head>
<body>
    <h1>Python Real-time Data via WebSocket</h1>
    <p>Status: <span id="status">Connecting...</span></p>
    <div id="data-container">
        <p>Waiting for data...</p>
    </div>

    <!-- D3.js 可视化容器 (示例) -->
    <svg id="d3-chart" class="chart" width="600" height="300"></svg>

    <script>
        const statusDisplay = document.getElementById('status');
        const dataContainer = document.getElementById('data-container');
        const d3Chart = d3.select("#d3-chart"); // D3 选择器

        // WebSocket 服务器的地址
        // 'ws://' 表示 WebSocket 协议 (非加密)
        // 'wss://' 表示安全的 WebSocket 协议 (加密)
        const socketUrl = 'ws://localhost:8765'; // 确保这里的端口号与 Python 服务器一致

        // 创建 WebSocket 连接
        const socket = new WebSocket(socketUrl);

        // 1. 连接建立时触发
        socket.onopen = function(event) {
            console.log('[open] Connection established with WebSocket server.');
            statusDisplay.textContent = 'Connected!';
            statusDisplay.style.color = 'green';
            dataContainer.innerHTML = '<p>Connection successful. Waiting for data...</p>';
            // 你可以在连接成功后向服务器发送一条消息（如果服务器需要）
            // socket.send(JSON.stringify({ client_message: "Hello from JavaScript!" }));
        };

        // 2. 接收到服务器消息时触发
        socket.onmessage = function(event) {
            console.log(`[message] Data received from server: ${event.data}`);
            try {
                const receivedData = JSON.parse(event.data); // 将 JSON 字符串解析为 JavaScript 对象

                // 在 data-container 中显示原始数据
                const newItem = document.createElement('div');
                newItem.classList.add('data-item');
                newItem.textContent = `Timestamp: ${new Date(receivedData.timestamp * 1000).toLocaleString()}, Value1: ${receivedData.value1}, Value2: ${receivedData.value2.toFixed(3)}`;

                // 为了简单，我们只保留最新的几条数据
                if (dataContainer.firstChild && dataContainer.firstChild.tagName === 'P') {
                    dataContainer.innerHTML = ''; // 清除 "Waiting for data..."
                }
                dataContainer.prepend(newItem); // 在顶部添加新数据
                while (dataContainer.children.length > 10) { // 最多显示10条
                    dataContainer.removeChild(dataContainer.lastChild);
                }

                // TODO: 在这里调用你的 D3.js 函数来更新可视化
                // 例如: updateD3Chart(receivedData);
                // 简单示例：在 D3 图表上画一个随 value1 变化的圆
                updateSimpleD3Circle(receivedData);

            } catch (e) {
                console.error('Error parsing JSON or processing message:', e);
                const errorItem = document.createElement('div');
                errorItem.style.color = 'red';
                errorItem.textContent = `Error processing data: ${event.data}`;
                dataContainer.prepend(errorItem);
            }
        };

        // 3. 连接关闭时触发
        socket.onclose = function(event) {
            if (event.wasClean) {
                console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                statusDisplay.textContent = `Disconnected: ${event.reason || 'Connection closed'}`;
            } else {
                // 例如服务器进程被杀死或网络中断
                console.error('[close] Connection died');
                statusDisplay.textContent = 'Connection Died. Try refreshing. Is the Python server running?';
            }
            statusDisplay.style.color = 'red';
        };

        // 4. 发生错误时触发
        socket.onerror = function(error) {
            console.error(`[error] ${error.message}`);
            statusDisplay.textContent = `WebSocket Error: ${error.message}. Check console.`;
            statusDisplay.style.color = 'red';
        };

        // --- D3.js 示例函数 ---
        const chartWidth = 600;
        const chartHeight = 300;
        const chartMargin = {top: 20, right: 20, bottom: 30, left: 40};
        const boundedWidth = chartWidth - chartMargin.left - chartMargin.right;
        const boundedHeight = chartHeight - chartMargin.top - chartMargin.bottom;

        const g = d3Chart.append("g")
            .attr("transform", `translate(${chartMargin.left},${chartMargin.top})`);

        // 初始设置一个圆，后面会更新它
        const circle = g.append("circle")
            .attr("cx", boundedWidth / 2)
            .attr("cy", boundedHeight / 2)
            .attr("r", 10)
            .attr("fill", "steelblue");

        function updateSimpleD3Circle(data) {
            // 用 value1 来改变圆的半径，value2 来改变颜色 (简单示例)
            const newRadius = Math.max(5, data.value1 / 5); // 半径范围
            const colorScale = d3.scaleSequential(d3.interpolateViridis) // D3颜色插值器
                                 .domain([0, 1]); // 假设 value2 在 0-1 之间

            circle.transition() // 添加过渡效果
                  .duration(500) // 过渡时间 500ms
                  .attr("r", newRadius)
                  .attr("fill", colorScale(data.value2));

            // 你可以在这里构建更复杂的 D3.js 可视化逻辑
            // 例如，更新条形图、折线图等
        }

        // 确保在页面卸载时关闭 WebSocket 连接（好习惯）
        window.addEventListener('beforeunload', function() {
            if (socket.readyState === WebSocket.OPEN) {
                socket.close(1000, "Page is closing");
            }
        });

    </script>
</body>
</html>